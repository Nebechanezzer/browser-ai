<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smarter AI Chatbot</title>
  <script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.10.0';

    let generator;
    let conversationHistory = "";

    // System prompt helps steer behavior
    const systemPrompt = "You are a helpful, friendly, and funny assistant. Answer clearly, avoid repeating the user.";

    window.addEventListener('DOMContentLoaded', async () => {
      const status = document.getElementById('status');
      const output = document.getElementById('output');
      const input = document.getElementById('user-input');
      const button = document.getElementById('submit');

      status.textContent = 'Loading model... (can take 10â€“30 sec)';
      generator = await pipeline('text-generation', 'Xenova/distilgpt2');
      status.textContent = 'Ready! Ask me anything.';

      button.addEventListener('click', async () => {
        const userMessage = input.value.trim();
        if (!userMessage) return;
        input.value = '';

        output.innerHTML += `<p><b>You:</b> ${userMessage}</p>`;
        status.textContent = 'Thinking...';

        // Format prompt with history
        const prompt = `${systemPrompt}\n${conversationHistory}User: ${userMessage}\nBot:`;

        const result = await generator(prompt, {
          max_new_tokens: 60,
          temperature: 0.8,
          top_k: 50,
          repetition_penalty: 1.25
        });

        let reply = result[0].generated_text.replace(prompt, '').trim();

        // Sanitize the response
        reply = reply
          .split('\n')[0]                           // only first line
          .replace(/[^a-zA-Z0-9.,?!'"()\s\-]/g, '') // remove emojis and weird symbols
          .replace(/(.)\1{4,}/g, '$1')              // limit character spam
          .replace(/(.*)\1{1,}/, '$1');             // remove repeated phrases

        // Avoid exact echo
        if (reply.toLowerCase() === userMessage.toLowerCase()) {
          reply = "Haha, I won't just repeat you!";
        }

        output.innerHTML += `<p><b>Bot:</b> ${reply}</p>`;
        status.textContent = 'Ready!';

        // Update convo history
        conversationHistory += `User: ${userMessage}\nBot: ${reply}\n`;
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') button.click();
      });
    });
  </script>
</head>
<body style="font-family: sans-serif; padding: 2em;">
  <h2>ðŸ¤– AI Chatbot (Now Less Dumb)</h2>
  <div id="status">Initializing...</div>
  <div id="output" style="margin: 1em 0; background: #f0f0f0; padding: 1em; border-radius: 8px; min-height: 100px;"></div>
  <input id="user-input" type="text" style="width: 70%;" placeholder="Say something..." />
  <button id="submit">Send</button>
</body>
</html>
